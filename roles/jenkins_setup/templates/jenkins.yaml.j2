# roles/jenkins_setup/templates/jenkins.yaml.j2
jenkins:
  securityRealm:
    local:
      allowsSignup: false
      users:
        - id: "{{ admin_id }}"
          password: "{{ admin_pw }}"
  authorizationStrategy:
    loggedInUsersCanDoAnything:
      allowAnonymousRead: false

  globalNodeProperties:
    - envVars:
        env:
          - key: "ansible"
            value: "{{ ansible_bin_path }}"
          - key: "PYTHONPATH"
            value: "{{ python_path }}"
          - key: "ANSIBLE_HOST_KEY_CHECKING"
            value: "False"

unclassified:
  location:
    url: "http://{{ ansible_host }}:8080/"

jobs:
  - script: |
      pipelineJob('{{ jenkins_job_name }}') {
        // [1] í† í°ë„ ì¼ë‹¨ì€ ê°€ì¥ ë‹¨ìˆœí•˜ê²Œ ì²˜ë¦¬
        authenticationToken('{{ token_raw['content'] | b64decode | trim }}')
        
        definition {
          cps {
            script('''
              pipeline {
                agent any
                stages {
                  stage('Checkout') {
                    steps {
                      sh "git config --global --add safe.directory '*'"
                      git branch: 'main', url: 'file://{{ git_dir }}'
                    }
                  }
                  stage('Deploy to Web Server') {
                    steps {
                      sh """
                      REPO="/home/ansible-admin/project/Project04-CI-CD-collection"

                      export ANSIBLE_HOST_KEY_CHECKING=False
                      export ANSIBLE_PRIVATE_KEY_FILE="/var/jenkins_home/.ssh/jenkins_deploy"
                      export ANSIBLE_SSH_ARGS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"

                      set -o pipefail
                      ansible-playbook -i "${REPO}/inventory/hosts.ini" "${REPO}/web_deploy.yml" \
                      -e "src_path=${WORKSPACE}/web/" \
                      | tee ansible_output.log
                    """
                    }
                  }
                }
                post {
                  success { echo 'ğŸ‰ ë°°í¬ ì„±ê³µ!' }
                  failure {
                    // ë³€ìˆ˜ ì—†ì´ ê³ ì • íŒŒì¼ëª…ìœ¼ë¡œ ë¡œê·¸ ë³µì‚¬
                    sh "cp ansible_output.log {{ base_dir }}/logs/deploy_error.log"
                  }
                  always { 
                    echo "ë¹Œë“œ ì™„ë£Œ"
                  }
                }
              }
            '''.stripIndent())
            sandbox(true)
          }
        }
      }
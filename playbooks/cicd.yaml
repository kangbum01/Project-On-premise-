---
- name: "Step 1: ansible 기초 세팅"
  hosts: jenkins
  connection: local
  become: false 
  tasks:
    - name: "1-0. 도커 설치 방해 요소 제거 (Podman 비활성화)"
      block:
        - name: "1-0-1. Podman 관련 서비스 정지 및 마스킹"
          ansible.builtin.systemd:
            name: "{{ item }}"
            state: stopped
            enabled: false
            masked: true
          loop:
            - podman.socket
            - podman.service
          ignore_errors: true

        - name: "1-0-2. 도커 명령어 경로 충돌 패키지 제거"
          ansible.builtin.package:
            name: podman-docker
            state: absent
      become: true

    - name: "1-1. Docker 엔진 및 필수 패키지 설치"
      block:
        - name: "1-1-1. yum-utils 설치 및 리포지토리 추가"
          ansible.builtin.package:
            name: yum-utils
            state: present

        - name: "1-1-2. Docker 공식 리포지토리 추가"
          ansible.builtin.get_url:
            url: https://download.docker.com/linux/centos/docker-ce.repo
            dest: /etc/yum.repos.d/docker-ce.repo
            mode: '0644'

        - name: "1-1-3. Docker CE 및 SDK 설치"
          ansible.builtin.package:
            name: ["docker-ce", "docker-ce-cli", "containerd.io", "python3-pip"]
            state: present

        - name: "1-1-4. pip로 Docker SDK 설치"
          ansible.builtin.pip:
            name: docker
            state: present
      become: true

    - name: "1-2. Ansible 컬렉션 준비"
      block:
        - name: "1-2-1. ansible-galaxy 명령어 위치 찾기"
          ansible.builtin.command: which ansible-galaxy
          register: found_galaxy
          changed_when: false

        - name: "1-2-2. 필수 컬렉션 설치( Docker & General )"
          ansible.builtin.command: 
            cmd: "{{ found_galaxy.stdout | default('ansible-galaxy') }} collection install {{ item }}"
          loop:
            - community.docker
            - community.general
          register: res
          changed_when: "'nothing to do' not in res.stdout"

- name: "Step 2: Jenkins 설치"
  hosts: jenkins
  become: true
  roles:
    - jenkins_setup

- name: "Step 3: Local Git 설치"
  hosts: jenkins
  become: true
  roles:
    - git_install
          